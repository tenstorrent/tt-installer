name: Test Installer - Fedora

on:
  workflow_call:
    inputs:
      artifact_name:
        description: 'Name of the install script artifact'
        required: true
        type: string
        default: 'install-script'

jobs:
  test-fedora:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        distro:
          - fedora:41
          - fedora:42

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download install.sh
      uses: actions/download-artifact@v4
      with:
        name: ${{ inputs.artifact_name }}

    - name: Free disk space on runner
      uses: jlumbroso/free-disk-space@main
      with:
        toolcache: true
        android: true
        dotnet: true
        haskell: true
        large-packages: true

    - name: Test in Fedora container
      timeout-minutes: 30
      run: |
        docker run --rm -v "$PWD:/workspace" -w /workspace ${{ matrix.distro }} bash -c "
          set -e

          # Update package manager and install sudo
          dnf update -y
          dnf install -y git python3-pip jq curl sudo

          # Create a non-root user for testing
          useradd -m -s /bin/bash testuser
          echo 'testuser ALL=(ALL) NOPASSWD:ALL' > /etc/sudoers.d/testuser

          # Copy workspace to user home and change ownership
          cp -r /workspace /home/testuser/workspace
          chown -R testuser:testuser /home/testuser/workspace

          # Switch to test user and run installer
          su - testuser -c '
            set -euo pipefail
            cd /home/testuser/workspace

            # Run installer with test configuration (skip hardware-dependent steps)
            bash install.sh \
              --mode-non-interactive \
              --install-kmd \
              --install-hugepages \
              --update-firmware=on \
              --install-metalium-container \
              --install-sfpi \
              --python-choice=new-venv \
              --reboot-option=never

            echo \"âœ“ Installer completed successfully in Fedora\"
          '
        "